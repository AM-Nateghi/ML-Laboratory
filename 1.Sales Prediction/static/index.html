<!DOCTYPE html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>فرم پیش‌بینی فروش</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  </head>
  <body
    class="bg-gradient-to-br from-gray-100 to-gray-200 min-h-screen flex items-center justify-center p-4"
  >
    <div class="bg-white shadow-2xl rounded-xl p-8 w-full max-w-3xl">
      <h1 class="text-2xl font-bold text-center mb-6 text-indigo-700">
        پنل پیش‌بینی فروش
      </h1>

      <form id="predictForm" class="space-y-4">
        <!-- Customers -->
        <div>
          <label class="block mb-1 font-medium">تعداد مشتریان</label>
          <input
            type="number"
            name="Customers"
            class="w-full border rounded-lg p-2 focus:ring focus:ring-indigo-200"
          />
          <span class="text-red-500 text-sm hidden" id="err_Customers"></span>
        </div>

        <!-- Store Type -->
        <div>
          <label class="block mb-1">نوع فروشگاه</label>
          <select name="StoreType" class="w-full border rounded-lg p-2">
            <option value="">انتخاب کنید</option>
            <option value="0">سوپرمارکت کوچک 🛒</option>
            <option value="1">هایپرمارکت 🏢</option>
            <option value="2">فروشگاه تخصصی 🎯</option>
            <option value="3">فروشگاه زنجیره‌ای بزرگ 🏬</option>
          </select>
          <span class="text-red-500 text-sm hidden" id="err_StoreType"></span>
        </div>

        <!-- Assortment -->
        <div>
          <label class="block mb-1">تنوع کالا</label>
          <select name="Assortment" class="w-full border rounded-lg p-2">
            <option value="">انتخاب کنید</option>
            <option value="0">کم</option>
            <option value="1">متوسط</option>
            <option value="2">زیاد</option>
          </select>
          <span class="text-red-500 text-sm hidden" id="err_Assortment"></span>
        </div>

        <!-- State Holiday -->
        <div>
          <label class="block mb-1">تعطیلات رسمی</label>
          <select name="StateHoliday" class="w-full border rounded-lg p-2">
            <option value="false">روز کاری</option>
            <option value="true">تعطیل رسمی 🏖️</option>
          </select>
        </div>

        <!-- School Holiday -->
        <div>
          <label class="block mb-1">تعطیلی مدارس</label>
          <select name="SchoolHoliday" class="w-full border rounded-lg p-2">
            <option value="false">مدارس باز</option>
            <option value="true">مدارس تعطیل 🏫🚪</option>
          </select>
        </div>

        <!-- Promo -->
        <div>
          <label class="block mb-1">پروموشن فعال</label>
          <select name="Promo" class="w-full border rounded-lg p-2">
            <option value="false">بدون تخفیف</option>
            <option value="true">دارای تخفیف 🎉</option>
          </select>
        </div>

        <!-- Has Competition -->
        <div>
          <label class="flex items-center">
            <input
              type="checkbox"
              id="HasCompetition"
              name="HasCompetition"
              class="w-4 h-4"
            />
            <span class="ml-2">Has Competition</span>
          </label>
        </div>
        <div id="competitionFields" class="hidden grid grid-cols-3 gap-4">
          <input
            type="number"
            step="0.1"
            name="CompetitionDistance"
            placeholder="فاصله رقبا"
            class="border rounded-lg p-2"
          />
          <input
            type="number"
            name="CompetitionOpenSinceMonth"
            placeholder="ماه شروع"
            class="border rounded-lg p-2"
          />
          <input
            type="number"
            name="CompetitionOpenSinceYear"
            placeholder="سال شروع"
            class="border rounded-lg p-2"
          />
        </div>
        <span class="text-red-500 text-sm hidden" id="err_Competition"></span>

        <!-- Promo2 -->
        <div>
          <label class="flex items-center">
            <input type="checkbox" id="Promo2" name="Promo2" class="w-4 h-4" />
            <span class="ml-2">Promo2</span>
          </label>
        </div>
        <div id="promo2Fields" class="hidden grid grid-cols-3 gap-4">
          <input
            type="number"
            name="Promo2SinceWeek"
            placeholder="از هفته"
            class="border rounded-lg p-2"
          />
          <input
            type="number"
            name="Promo2SinceYear"
            placeholder="از سال"
            class="border rounded-lg p-2"
          />
          <input
            type="number"
            name="PromoInterval"
            placeholder="Interval"
            class="border rounded-lg p-2"
          />
        </div>
        <span class="text-red-500 text-sm hidden" id="err_Promo2"></span>

        <!-- Date -->
        <div class="grid grid-cols-2 gap-4">
          <input
            type="number"
            name="month"
            placeholder="ماه"
            class="border rounded-lg p-2"
          />
          <input
            type="number"
            name="year"
            placeholder="سال"
            class="border rounded-lg p-2"
          />
        </div>
        <span class="text-red-500 text-sm hidden" id="err_Date"></span>

        <!-- Submit -->
        <button
          type="submit"
          class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition"
        >
          ارسال
        </button>
      </form>

      <!-- Result -->
      <div
        id="result"
        class="mt-6 text-center text-lg font-semibold text-gray-700"
      ></div>
    </div>

    <script>
      $(document).ready(function () {
        // Toggle fields
        $("#HasCompetition").change(function () {
          $("#competitionFields").toggle(this.checked);
        });
        $("#Promo2").change(function () {
          $("#promo2Fields").toggle(this.checked);
        });

        // Custom validation
        $("#predictForm").submit(function (e) {
          e.preventDefault();
          let valid = true;

          // Reset errors
          $("span[id^='err_']").addClass("hidden").text("");

          let customers = $("input[name='Customers']").val();
          if (customers < 20 || customers > 6000 || customers === "") {
            $("#err_Customers")
              .removeClass("hidden")
              .text("تعداد مشتریان باید بین 20 تا 6000 باشد");
            valid = false;
          }

          let storeType = $("input[name='StoreType']").val();
          if (storeType < 0 || storeType > 3 || storeType === "") {
            $("#err_StoreType")
              .removeClass("hidden")
              .text("Store Type باید بین 0 تا 3 باشد");
            valid = false;
          }

          let assortment = $("input[name='Assortment']").val();
          if (assortment < 0 || assortment > 2 || assortment === "") {
            $("#err_Assortment")
              .removeClass("hidden")
              .text("Assortment باید بین 0 تا 2 باشد");
            valid = false;
          }

          if ($("#HasCompetition").is(":checked")) {
            let compFields = [
              "CompetitionDistance",
              "CompetitionOpenSinceMonth",
              "CompetitionOpenSinceYear",
            ];
            for (let f of compFields) {
              if ($(`input[name='${f}']`).val() === "") {
                $("#err_Competition")
                  .removeClass("hidden")
                  .text("لطفا تمام فیلدهای رقبا را پر کنید");
                valid = false;
                break;
              }
            }
          }

          if ($("#Promo2").is(":checked")) {
            let promo2Fields = [
              "Promo2SinceWeek",
              "Promo2SinceYear",
              "PromoInterval",
            ];
            for (let f of promo2Fields) {
              if ($(`input[name='${f}']`).val() === "") {
                $("#err_Promo2")
                  .removeClass("hidden")
                  .text("لطفا تمام فیلدهای Promo2 را پر کنید");
                valid = false;
                break;
              }
            }
          }

          let month = $("input[name='month']").val();
          let year = $("input[name='year']").val();
          if (month < 1 || month > 12 || month === "" || year === "") {
            $("#err_Date")
              .removeClass("hidden")
              .text("ماه باید بین 1 تا 12 باشد و سال را وارد کنید");
            valid = false;
          }

          if (!valid) return;

          // Prepare data
          let formData = $("#predictForm").serializeArray();
          let data = {};
          formData.forEach((item) => {
            data[item.name] =
              item.value === "on"
                ? true
                : isNaN(item.value) || item.value === ""
                ? item.value
                : Number(item.value);
          });

          // Send request
          $.ajax({
            url: "/predict",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify(data),
            success: function (res) {
              $("#result").text(JSON.stringify(res));
            },
            error: function () {
              $("#result").text("خطا در ارسال داده");
            },
          });
        });
      });
    </script>
  </body>
</html>
